<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Define custom health checks :: Efficient Resource Management with OpenShift</title>
    <link rel="canonical" href="https://redhat-scholars.github.io/openshift-apps-resource-management/health.html">
    <link rel="prev" href="configuration.html">
    <link rel="next" href="openshift.html">
    <meta name="generator" content="Antora 3.0.0">
    <link rel="stylesheet" href="../_/css/site.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img src="../_/img/NewRHDFullLogo_4-color_white-wordmark.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="https://redhat-scholars.github.io">Efficient Resource Management with OpenShift</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://developers.redhat.com/ebooks/" target="_blank">Books</a>
        <a class="navbar-item" href="https://developers.redhat.com/cheatsheets/" target="_blank">Cheat Sheets</a>
        <a class="navbar-item" href="https://developers.redhat.com/events/" target="_blank">Upcoming Events</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/kubernetes-tutorial/" target="_blank">Kubernetes</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/istio-tutorial/" target="_blank">Istio</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/quarkus-tutorial/" target="_blank">Quarkus</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/knative-tutorial/" target="_blank">Knative</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/tekton-tutorial/" target="_blank">Tekton</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="openshift-apps-resource-management" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html"></a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="setup.html">Requirements</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="setup.html">Setup</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="starter.html">Development Practices</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="starter.html">Bootstrap project</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="configuration.html">Adapt configurations</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="health.html">Define custom health checks</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="openshift.html">Deploy to OpenShift</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="resources.html">Adjust resource quotas</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="separate.html">Test configurations</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="metrics.html">Tailor metrics</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="monitoring.html">Sizing resource limits</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Efficient Resource Management with OpenShift</a></li>
    <li><a href="starter.html">Development Practices</a></li>
    <li><a href="health.html">Define custom health checks</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/redhat-scholars/openshift-apps-resource-management/edit/master/documentation/modules/ROOT/pages/health.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Define custom health checks</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>While you coded the database configuration in the previous exercise, Quarkus has generated Kubernetes and OpenShift resources in <code>target/kubernetes</code>:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-config hljs" data-lang="config">target/kubernetes
|-- kubernetes.json
|-- kubernetes.yml
|-- openshift.json
`-- openshift.yml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Inspect their content and observe that you already have a base for your Kubernetes deployment.
But before doing that, let&#8217;s implement custom health checks.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_add_the_health_monitoring_extension"><a class="anchor" href="#_add_the_health_monitoring_extension"></a>Add the health monitoring extension</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In the terminal window please execute the following command:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-config hljs" data-lang="config">./mvnw quarkus:add-extension -Dextensions="io.quarkus:quarkus-smallrye-health"</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you did not stop DevMode and inspect again <code>target/kubernetes/kubernetes.yml</code> or <code>target/kubernetes/openshift.yml</code>
will notice that it had changed. Your Deployment/DeploymentConfig resource will contain a few lines like to:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-config hljs" data-lang="config">          livenessProbe:
            failureThreshold: 3
            httpGet:
              path: /q/health/live
              port: 8080
              scheme: HTTP
            initialDelaySeconds: 0
            periodSeconds: 30
            successThreshold: 1
            timeoutSeconds: 10
          name: tutorial-app
          ports:
            - containerPort: 8080
              name: http
              protocol: TCP
          readinessProbe:
            failureThreshold: 3
            httpGet:
              path: /q/health/ready
              port: 8080
              scheme: HTTP
            initialDelaySeconds: 0
            periodSeconds: 30
            successThreshold: 1
            timeoutSeconds: 10</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
You can access these endpoints also in your local at <a href="http://localhost:8080/q/health/ready" class="bare">http://localhost:8080/q/health/ready</a> or <a href="http://localhost:8080/q/health/live" class="bare">http://localhost:8080/q/health/live</a>.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_default_health_checks"><a class="anchor" href="#_default_health_checks"></a>Default health checks</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In dev mode, all your heath checks are visible in health UI: <a href="http://localhost:8080/q/health-ui/" class="bare">http://localhost:8080/q/health-ui/</a>.</p>
</div>
<div class="paragraph">
<p>Some extensions may provide default health checks, including that the extension will automatically register its health checks.
For example, <code>quarkus-agroal</code> (that is used to manage Quarkus datasources)  automatically registers a readiness health check that will validate each datasource.</p>
</div>
<div class="paragraph">
<p>Quarkus has automatic readiness probes added when you use certain extensions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>datasource</strong>
A probe to check database connection status.</p>
</li>
<li>
<p><strong>kafka</strong>
A probe to check kafka connection status. In this case you need to enable manually by setting quarkus.kafka.health.enabled to true.</p>
</li>
<li>
<p><strong>mongoDB</strong>
A probe to check MongoDB connection status.</p>
</li>
<li>
<p><strong>neo4j</strong>
A probe to check Neo4J connection status.</p>
</li>
<li>
<p><strong>artemis</strong>
A probe to check Artemis JMS connection status.</p>
</li>
<li>
<p><strong>kafka-streams</strong>
Liveness (for stream state) and Readiness (topics created) probes.</p>
</li>
<li>
<p><strong>vault</strong>
A probe to check Vault conection status.</p>
</li>
<li>
<p><strong>gRPC</strong>
A readiness probe for the gRPC services.</p>
</li>
<li>
<p><strong>Cassandra</strong>
A readiness probe to check Cassandra connection status.</p>
</li>
<li>
<p><strong>Redis</strong>
A readiness probe to check Redis connection status.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_customize_integrations_and_startup_configurations"><a class="anchor" href="#_customize_integrations_and_startup_configurations"></a>Customize integrations and startup configurations</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Let&#8217;s assume that at application startup we insert some data in our database, but
we should also update the message content from an external service.
This type of scenario requires customizing health checks for the readiness probe to take into account the second dependency.</p>
</div>
<div class="sect2">
<h3 id="_add_the_rest_client_extension"><a class="anchor" href="#_add_the_rest_client_extension"></a>Add the REST Client extension</h3>
<div class="paragraph">
<p>In the terminal window please execute the following command
:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-config hljs" data-lang="config">./mvnw quarkus:add-extension -Dextensions="io.quarkus:quarkus-rest-client"</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_consuming_a_rest_endpoint"><a class="anchor" href="#_consuming_a_rest_endpoint"></a>Consuming a REST endpoint</h3>
<div class="paragraph">
<p>Implement a simple data access object (DTO) to help reading the data:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package com.redhat.developers;

import com.fasterxml.jackson.annotation.JsonIgnoreProperties;

@JsonIgnoreProperties(ignoreUnknown = true)
public class ExternalGreeting {
    public String hello;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>And now let&#8217;s define an interface and register it as a REST client:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package com.redhat.developers;

import org.eclipse.microprofile.rest.client.inject.RegisterRestClient;

import jakarta.ws.rs.GET;
import jakarta.ws.rs.Path;
import jakarta.ws.rs.Produces;
import jakarta.ws.rs.QueryParam;
import jakarta.ws.rs.core.MediaType;



@RegisterRestClient
@Path("/hellosalut")
public interface HelloService {

    @GET
    @Path("/")
    @Produces(MediaType.APPLICATION_JSON)
    ExternalGreeting getContent(@QueryParam("lang") String lang);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>And add in <code>src/main/resources/application.properties</code>:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-config hljs" data-lang="config">com.redhat.developers.HelloService/mp-rest/url=https://fourtonfish.com</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_define_actions_at_startup_initialization"><a class="anchor" href="#_define_actions_at_startup_initialization"></a>Define actions at startup initialization</h3>
<div class="paragraph">
<p>Furthermore, we can use the previously defined endpoint to update our data using an intermediary repository:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package com.redhat.developers;

import io.quarkus.hibernate.orm.panache.PanacheRepository;
import io.quarkus.panache.common.Parameters;
import jakarta.enterprise.context.ApplicationScoped;
import jakarta.transaction.Transactional;


@ApplicationScoped
public class GreetingRepository implements PanacheRepository&lt;Message&gt; {

    @Transactional
    public int update(String content, String language) {
        return update("content= :content where language= :language ",
                Parameters.with("content", content)
                        .and("language", language));
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>And inject this class in the one used to customize startup initialization of data:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package com.redhat.developers;

import io.quarkus.arc.profile.UnlessBuildProfile;
import io.quarkus.runtime.Startup;
import jakarta.annotation.PostConstruct;
import jakarta.enterprise.context.ApplicationScoped;
import jakarta.inject.Inject;

import org.eclipse.microprofile.rest.client.inject.RestClient;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;


import java.util.List;

@Startup <i class="conum" data-value="1"></i><b>(1)</b>
@ApplicationScoped
@UnlessBuildProfile("test") <i class="conum" data-value="2"></i><b>(2)</b>
public class MessageInitializer {
    private static final Logger LOGGER = LoggerFactory.getLogger(MessageInitializer.class);

    @Inject
    @RestClient
    HelloService helloService; <i class="conum" data-value="3"></i><b>(3)</b>

    @Inject
    GreetingRepository repository; <i class="conum" data-value="4"></i><b>(4)</b>

    @PostConstruct
    public void init() {
        LOGGER.debug("Updating the db from external service");
        List&lt;Message&gt; messages = Message.findAll().list();
        for (Message message : messages) {
            String language = message.getLanguage();
            repository.update(helloService.getContent(language).hello, language);
        }
        LOGGER.debug("End update of the db ");
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This annotation initializes a CDI bean at application startup.
This code will be executed after initializing the database from <code>import.sql</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Enable for both prod and dev build time profiles.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Inject the <code>RestClient</code> service.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Inject the service that updates database content and has <code>@Transactional</code> annotation set on the invoked method.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Invoke record update.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_customize_health_endpoints_and_readiness_probe"><a class="anchor" href="#_customize_health_endpoints_and_readiness_probe"></a>Customize health endpoints and readiness probe</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You can change the root path to the health endpoints by setting the following property in <code>src/main/resources/application.properties</code>:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-config hljs" data-lang="config">quarkus.smallrye-health.root-path=/health</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Quarkus Kubernetes/OpenShift extension will take into account your custom probe definitions when generating their YAML.
If you reload the context in DevMode (by pressing <code>s</code>), you would notice that your Kubernetes/OpenShift manifests have changed and take into account your new configuration.</p>
</div>
<div class="paragraph">
<p>As the database readiness is already assessed, we can customize another readiness probe to check the availability of the endpoint <code><a href="https://fourtonfish.com" class="bare">https://fourtonfish.com</a></code>:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package com.redhat.developers;

import io.smallrye.health.checks.UrlHealthCheck;
import jakarta.enterprise.context.ApplicationScoped;
import jakarta.ws.rs.HttpMethod;

import org.eclipse.microprofile.config.inject.ConfigProperty;
import org.eclipse.microprofile.health.HealthCheck;
import org.eclipse.microprofile.health.Readiness;


@ApplicationScoped
public class CustomHealthCheck {

    @ConfigProperty(name = "com.redhat.developers.HelloService/mp-rest/url")
    String externalURL;

    @Readiness <i class="conum" data-value="1"></i><b>(1)</b>
    HealthCheck checkURL() {
        return new UrlHealthCheck(externalURL+"/hellosalut/?lang=en") <i class="conum" data-value="2"></i><b>(2)</b>
                .name("external-url-check").requestMethod(HttpMethod.GET).statusCode(200);
    }

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Annotate the method with <code>org.eclipse.microprofile.health.Readiness</code> to signal its implementation.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>UrlHealthCheck</code> checks if host is reachable using a Http URL connection.</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Quarkus comes with some HealthCheck implementations for you to check status of different components:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>SocketHealthCheck: checks if host is reachable using a socket.</p>
</li>
<li>
<p>UrlHealthCheck: checks if host is reachable using a Http URL connection.</p>
</li>
<li>
<p>InetAddressHealthCheck: checks if host is reachable using InetAddress.isReachable method.</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="configuration.html">Adapt configurations</a></span>
  <span class="next"><a href="openshift.html">Deploy to OpenShift</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../_/js/vendor/clipboard.js"></script>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
